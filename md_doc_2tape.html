<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>simdjson: Tape structure in simdjson</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logotiny.png"/></td>
  <td id="projectalign">
   <div id="projectname">simdjson<span id="projectnumber">&#160;4.0.7</span>
   </div>
   <div id="projectbrief">Ridiculously Fast JSON</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2tape.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tape structure in simdjson</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md122"></a> We parse a JSON document to a tape. A tape is an array of 64-bit values. Each node encountered in the JSON document is written to the tape using one or more 64-bit tape elements; the layout of the tape is in "document order": elements are stored as they are encountered in the JSON document.</p>
<p>Throughout, little endian encoding is assumed. The tape is indexed starting at 0 (the first element is at index 0).</p>
<h1><a class="anchor" id="autotoc_md123"></a>
Example</h1>
<p>It is sometimes useful to start with an example. Consider the following JSON document:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;Image&quot;: {</div>
<div class="line">        &quot;Width&quot;: 800,</div>
<div class="line">        &quot;Height&quot;: 600,</div>
<div class="line">        &quot;Title&quot;: &quot;View from 15th Floor&quot;,</div>
<div class="line">        &quot;Thumbnail&quot;: {</div>
<div class="line">            &quot;Url&quot;: &quot;http://www.example.com/image/481989943&quot;,</div>
<div class="line">            &quot;Height&quot;: 125,</div>
<div class="line">            &quot;Width&quot;: 100</div>
<div class="line">        },</div>
<div class="line">        &quot;Animated&quot;: false,</div>
<div class="line">        &quot;IDs&quot;: [116, 943, 234, 38793]</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following is a dump of the content of the tape, with the first number of each line representing the index of a tape element.</p>
<h2><a class="anchor" id="autotoc_md124"></a>
The Tape</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">index   </th><th class="markdownTableHeadNone">element (64-bit word)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">r // pointing to 39 (right after last node)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">{ // pointing to next tape location 38 (first node after the scope)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">string "Image"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">3   </td><td class="markdownTableBodyNone">{ // pointing to next tape location 37 (first node after the scope)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">string "Width"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">integer 800    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">7   </td><td class="markdownTableBodyNone">string "Height"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">8   </td><td class="markdownTableBodyNone">integer 600    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">10   </td><td class="markdownTableBodyNone">string "Title"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">11   </td><td class="markdownTableBodyNone">string "View from 15th Floor"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">12   </td><td class="markdownTableBodyNone">string "Thumbnail"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">13   </td><td class="markdownTableBodyNone">{ // pointing to next tape location 23 (first node after the scope)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">14   </td><td class="markdownTableBodyNone">string "Url"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">15   </td><td class="markdownTableBodyNone">string "http://www.example.com/image/481989943"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">16   </td><td class="markdownTableBodyNone">string "Height"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">17   </td><td class="markdownTableBodyNone">integer 125    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">19   </td><td class="markdownTableBodyNone">string "Width"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">20   </td><td class="markdownTableBodyNone">integer 100    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">22   </td><td class="markdownTableBodyNone">} // pointing to previous tape location 13 (start of the scope)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">23   </td><td class="markdownTableBodyNone">string "Animated"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">24   </td><td class="markdownTableBodyNone">false    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">25   </td><td class="markdownTableBodyNone">string "IDs"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">26   </td><td class="markdownTableBodyNone">[ // pointing to next tape location 36 (first node after the scope)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">27   </td><td class="markdownTableBodyNone">integer 116    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">29   </td><td class="markdownTableBodyNone">integer 943    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">31   </td><td class="markdownTableBodyNone">integer 234    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">33   </td><td class="markdownTableBodyNone">integer 38793    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">35   </td><td class="markdownTableBodyNone">] // pointing to previous tape location 26 (start of the scope)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">36   </td><td class="markdownTableBodyNone">} // pointing to previous tape location 3 (start of the scope)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">37   </td><td class="markdownTableBodyNone">} // pointing to previous tape location 1 (start of the scope)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">38   </td><td class="markdownTableBodyNone">r // pointing to 0 (start root)   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md125"></a>
General formal of the tape elements</h1>
<p>Most tape elements are written as &lsquo;('c&rsquo; &lt;&lt; 56) + x<code>where</code>'c'&lsquo; is some ASCII character determining the type of the element (out of 't&rsquo;, 'f', 'n', 'l', 'u', 'd', '"', '{', '}', '[', ']' ,'r') and where <code>x</code> is a 56-bit value called the payload. The payload is normally interpreted as an unsigned 56-bit integer. Note that 56-bit integers can be quite large.</p>
<p>Performance consideration: We believe that accessing the tape in regular units of 64 bits is more important for performance than saving memory.</p>
<h1><a class="anchor" id="autotoc_md126"></a>
Simple JSON values</h1>
<p>Simple JSON nodes are represented with one tape element:</p>
<ul>
<li>null is represented as the 64-bit value &lsquo;('n&rsquo; &lt;&lt; 56)<code>where</code>'n'<code>is the 8-bit code point values (in ASCII) corresponding to the letter</code>'n'<code>.</code></li>
<li><code>true is represented as the 64-bit value</code>('t' &lt;&lt; 56)<code>.</code></li>
<li><code>false is represented as the 64-bit value</code>('f' &lt;&lt; 56)`.</li>
</ul>
<h1><a class="anchor" id="autotoc_md127"></a>
Integer and Double values</h1>
<p>Integer values are represented as two 64-bit tape elements:</p><ul>
<li>The 64-bit value &lsquo;('l&rsquo; &lt;&lt; 56)<code>followed by the 64-bit integer value literally. Integer values are assumed to be signed 64-bit values, using two's complement notation.</code></li>
<li><code>The 64-bit value</code>('u' &lt;&lt; 56)` followed by the 64-bit integer value literally. Integer values are assumed to be unsigned 64-bit values.</li>
</ul>
<p>Float values are represented as two 64-bit tape elements:</p><ul>
<li>The 64-bit value &lsquo;('d&rsquo; &lt;&lt; 56)` followed by the 64-bit double value literally in standard IEEE 754 notation.</li>
</ul>
<p>Performance consideration: We store numbers of the main tape because we believe that locality of reference is helpful for performance.</p>
<h1><a class="anchor" id="autotoc_md128"></a>
Root node</h1>
<p>Each JSON document will have two special 64-bit tape elements representing a root node, one at the beginning and one at the end.</p>
<ul>
<li>The first 64-bit tape element contains the value &lsquo;('r&rsquo; &lt;&lt; 56) + x<code>where</code>x<code>is the location on the tape of the last root element.</code></li>
<li><code>The last 64-bit tape element contains the value</code>('r' &lt;&lt; 56)`.</li>
</ul>
<p>All of the parsed document is located between these two 64-bit tape elements.</p>
<p>Hint: We can read the first tape element to determine the length of the tape.</p>
<h1><a class="anchor" id="autotoc_md129"></a>
Strings</h1>
<p>We prefix the string data itself by a 32-bit header to be interpreted as a 32-bit integer. It indicates the length of the string. The actual string data starts at an offset of 4 bytes.</p>
<p>We store string values using UTF-8 encoding with null termination on a separate tape. A string value is represented on the main tape as the 64-bit tape element &lsquo;(&rsquo;"' &lt;&lt; 56) + x<code>where the payload</code>x` is the location on the string tape of the null-terminated string.</p>
<h1><a class="anchor" id="autotoc_md130"></a>
Arrays</h1>
<p>JSON arrays are represented using two 64-bit tape elements.</p>
<ul>
<li>The first 64-bit tape element contains the value &lsquo;(&rsquo;[' &lt;&lt; 56) + (c &lt;&lt; 32) + x<code>where the payload</code>x<code>is 1 + the index of the second 64-bit tape element on the tape as a 32-bit integer and where</code>c<code>is the count of the number of elements (immediate children) in the array, satured to a 24-bit value (meaning that it cannot exceed 16777215 and if the real count exceeds 16777215, 16777215 is stored). Note that the exact count of elements can always be computed by iterating (e.g., when it is 16777215 or higher).</code></li>
<li><code>The second 64-bit tape element contains the value</code>(']' &lt;&lt; 56) + x<code>where the payload</code>x` contains the index of the first 64-bit tape element on the tape.</li>
</ul>
<p>All the content of the array is located between these two tape elements, including arrays and objects.</p>
<p>Performance consideration: We can skip the content of an array entirely by accessing the first 64-bit tape element, reading the payload and moving to the corresponding index on the tape.</p>
<h1><a class="anchor" id="autotoc_md131"></a>
Objects</h1>
<p>JSON objects are represented using two 64-bit tape elements.</p>
<ul>
<li>The first 64-bit tape element contains the value &lsquo;(&rsquo;{' &lt;&lt; 56) + (c &lt;&lt; 32) + x<code>where the payload</code>x<code>is 1 + the index of the second 64-bit tape element on the tape as a 32-bit integer and where</code>c<code>is the count of the number of key-value pairs (immediate children) in the array, satured to a 24-bit value (meaning that it cannot exceed 16777215 and if the real count exceeds 16777215, 16777215 is stored). Note that the exact count of key-value pairs can always be computed by iterating (e.g., when it is 16777215 or higher).</code></li>
<li><code>The second 64-bit tape element contains the value</code>('}' &lt;&lt; 56) + x<code>where the payload</code>x` contains the index of the first 64-bit tape element on the tape.</li>
</ul>
<p>In-between these two tape elements, we alternate between key (which must be strings) and values. A value could be an object or an array.</p>
<p>All the content of the object is located between these two tape elements, including arrays and objects.</p>
<p>Performance consideration: We can skip the content of an object entirely by accessing the first 64-bit tape element, reading the payload and moving to the corresponding index on the tape. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
