name: Ubuntu rvv VLEN=128 (clang 17)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      QEMU_LD_PREFIX: /usr/riscv64-linux-gnu
      # Canonical RVV CPU template (explicit spec + TA/MA agnostic + fixed VLEN)
      QEMU_CPU: rv64,v=on,vext_spec=v1.0,vlen=128,rvv_ta_all_1s=on,rvv_ma_all_1s=on
      # Support both names to avoid drift
      SIMDJSON_FORCE_IMPL: rvv
      SIMDJSON_FORCE_IMPLEMENTATION: rvv
    steps:
      - uses: actions/checkout@v4

      - name: Install packages
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -y cmake make g++-riscv64-linux-gnu qemu-user-static clang-17

      - name: Build
        run: |
          CXX=clang++-17 CXXFLAGS="--target=riscv64-linux-gnu -march=rv64gcv" \
          cmake --toolchain=cmake/toolchains-ci/riscv64-linux-gnu.cmake -DCMAKE_BUILD_TYPE=Release -B build
          cmake --build build/ -j"$(nproc)"

      - name: Test VLEN=128
        run: |
          ctest --timeout 1800 --output-on-failure --test-dir build -j"$(nproc)"
